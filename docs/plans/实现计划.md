# WebSocket 调试工具实现计划

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**目标：** 创建一个纯前端的 WebSocket 调试工具，支持连接管理、消息收发、心跳配置、自动重连、消息模板、配置导入导出等功能。

**架构：** 单 HTML 文件应用，内联 CSS 和 JavaScript，使用 localStorage 进行本地数据持久化，不依赖任何外部 CDN。

**技术栈：** HTML5、CSS3、原生 JavaScript（ES6+）、localStorage

---

## 项目结构

```
websocket-debug-tool/
├── index.html              # 主文件（包含 HTML/CSS/JS）
├── docs/
│   ├── 需求文档.md          # 需求规格说明
│   └── plans/
│       └── 实现计划.md      # 本计划文档
└── README.md               # 使用说明（可选）
```

---

## 任务清单

### 任务 1：项目初始化与基础 HTML 结构

**文件：**
- 创建: `index.html`

**步骤 1：创建基础 HTML 骨架**

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket 调试工具</title>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <h1>WebSocket 调试工具</h1>
            <div class="header-actions">
                <button onclick="exportConfig()">导出配置</button>
                <button onclick="importConfig()">导入配置</button>
                <button onclick="openTemplateModal()">模板管理</button>
                <button onclick="openSettingsModal()">设置</button>
            </div>
        </header>
        <!-- Main Content -->
        <main class="main-content">
            <!-- Left Panel -->
            <aside class="left-panel">
                <!-- 连接配置区域 -->
            </aside>
            <!-- Right Panel -->
            <section class="right-panel">
                <!-- 消息区域 -->
            </section>
        </main>
    </div>
</body>
</html>
```

**步骤 2：创建基础 CSS 变量和布局样式**

```css
:root {
    --bg-primary: #1e1e2e;
    --bg-secondary: #282a36;
    --bg-tertiary: #313244;
    --text-primary: #cdd6f4;
    --text-secondary: #a6adc8;
    --text-muted: #6c7086;
    --accent: #89b4fa;
    --success: #a6e3a1;
    --warning: #f9e2af;
    --error: #f38ba8;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    height: 100vh;
}

.app-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
}

.main-content {
    display: flex;
    flex: 1;
    overflow: hidden;
}

.left-panel {
    width: 320px;
    min-width: 280px;
    background: var(--bg-secondary);
    border-right: 1px solid var(--border-color);
    padding: 20px;
    overflow-y: auto;
}

.right-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--bg-primary);
}
```

**验证：** 浏览器打开 index.html，查看基础布局是否正确显示。

---

### 任务 2：连接配置模块

**文件：**
- 修改: `index.html`（在 left-panel 中添加连接配置）

**步骤 1：添加 URL 输入和协议选择**

```html
<div class="section">
    <h2 class="section-title">连接配置</h2>
    <div class="form-group">
        <label class="form-label">服务器地址</label>
        <input type="text" id="wsUrl" class="form-input"
               placeholder="wss://echo.websocket.org">
    </div>
    <div class="form-group">
        <label class="form-label">协议</label>
        <div class="radio-group">
            <label class="radio-label">
                <input type="radio" name="protocol" value="ws"> WS
            </label>
            <label class="radio-label">
                <input type="radio" name="protocol" value="wss" checked> WSS
            </label>
        </div>
    </div>
</div>
```

**步骤 2：添加连接按钮**

```html
<div class="btn-group">
    <button id="connectBtn" class="btn btn-primary" onclick="toggleConnection()">连接</button>
    <button id="disconnectBtn" class="btn btn-secondary" onclick="disconnect()" disabled>断开</button>
</div>
```

**步骤 3：添加连接状态指示器（右侧面板）**

```html
<div class="messages-header">
    <div class="status-indicator">
        <span class="status-dot disconnected" id="statusDot"></span>
        <span id="statusText">未连接</span>
    </div>
</div>
```

**步骤 4：实现连接逻辑**

```javascript
let ws = null;
let isConnected = false;

function toggleConnection() {
    if (isConnected) {
        disconnect();
    } else {
        connect();
    }
}

function connect() {
    const urlInput = document.getElementById('wsUrl');
    let url = urlInput.value.trim();

    if (!url) {
        showToast('请输入服务器地址', 'error');
        return;
    }

    // 添加协议前缀
    if (!url.startsWith('ws://') && !url.startsWith('wss://')) {
        const protocol = document.querySelector('input[name="protocol"]:checked').value;
        url = `${protocol}://${url}`;
    }

    try {
        ws = new WebSocket(url);

        ws.onopen = () => {
            isConnected = true;
            updateConnectionUI(true);
            showToast('连接成功', 'success');
        };

        ws.onmessage = (event) => {
            handleMessage(event.data);
        };

        ws.onclose = () => {
            isConnected = false;
            updateConnectionUI(false);
            showToast('连接已关闭', 'warning');
        };

        ws.onerror = (error) => {
            showToast('连接错误', 'error');
        };

        updateConnectionUI('connecting');

    } catch (error) {
        showToast('连接失败: ' + error.message, 'error');
    }
}

function disconnect() {
    if (ws) {
        ws.close();
        ws = null;
    }
    isConnected = false;
    updateConnectionUI(false);
}

function updateConnectionUI(status) {
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');

    statusDot.className = 'status-dot ' + status;

    if (status === true) {
        statusText.textContent = '已连接';
        connectBtn.textContent = '已连接';
        disconnectBtn.disabled = false;
    } else if (status === 'connecting') {
        statusText.textContent = '连接中...';
        connectBtn.disabled = true;
        connectBtn.textContent = '连接中...';
    } else {
        statusText.textContent = '未连接';
        connectBtn.textContent = '连接';
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
    }
}
```

**验证：** 输入 `wss://echo.websocket.org`，点击连接，检查状态是否变为"已连接"。

---

### 任务 3：消息收发功能

**文件：**
- 修改: `index.html`

**步骤 1：添加消息显示区域**

```html
<div class="messages-container" id="messagesContainer">
    <div class="empty-state" id="emptyState">
        <div class="empty-state-text">暂无消息，连接到 WebSocket 服务器开始调试</div>
    </div>
</div>
```

**步骤 2：添加消息输入区域**

```html
<div class="input-area">
    <div class="input-container">
        <textarea id="messageInput" class="message-textarea"
                  placeholder='{"type":"message","content":"Hello"}'></textarea>
        <div class="input-actions">
            <button class="btn btn-primary" onclick="sendMessage()">发送</button>
            <button class="btn btn-secondary" onclick="clearMessages()">清空</button>
        </div>
    </div>
</div>
```

**步骤 3：实现消息处理**

```javascript
let messages = [];

function handleMessage(data) {
    addMessage('receive', data);
}

function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (!message) {
        showToast('请输入消息内容', 'error');
        return;
    }

    if (!isConnected || !ws) {
        showToast('请先连接到服务器', 'error');
        return;
    }

    try {
        ws.send(message);
        addMessage('send', message);
        input.value = '';
    } catch (error) {
        showToast('发送失败: ' + error.message, 'error');
    }
}

function addMessage(type, content) {
    const container = document.getElementById('messagesContainer');
    const emptyState = document.getElementById('emptyState');
    const now = new Date();
    const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false });

    if (emptyState) {
        emptyState.remove();
    }

    const messageObj = {
        id: Date.now(),
        type,
        content,
        timestamp: now.getTime(),
        timeString: timeStr
    };
    messages.push(messageObj);

    const messageEl = document.createElement('div');
    messageEl.className = 'message-item';
    messageEl.innerHTML = `
        <div class="message-meta">
            <span class="message-time">${timeStr}</span>
            <span class="message-type ${type}">${type === 'send' ? '发送' : '接收'}</span>
        </div>
        <div class="message-content">
            <pre>${escapeHtml(content)}</pre>
        </div>
    `;

    container.appendChild(messageEl);
    container.scrollTop = container.scrollHeight;
}

function clearMessages() {
    messages = [];
    document.getElementById('messagesContainer').innerHTML = `
        <div class="empty-state" id="emptyState">
            <div class="empty-state-text">暂无消息</div>
        </div>
    `;
}

function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}
```

**步骤 4：添加键盘快捷键**

```javascript
document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'Enter') {
        sendMessage();
    }
    if (e.key === 'Escape') {
        if (isConnected) disconnect();
    }
});
```

**验证：** 连接后发送消息，检查消息是否正确显示在列表中。

---

### 任务 4：JSON 格式化和语法高亮

**文件：**
- 修改: `index.html`

**步骤 1：实现 JSON 格式化**

```javascript
function tryParseJson(str) {
    try {
        JSON.parse(str);
        return true;
    } catch (e) {
        return false;
    }
}

function formatJson(jsonStr) {
    try {
        const obj = JSON.parse(jsonStr);
        return JSON.stringify(obj, null, 2);
    } catch (e) {
        return jsonStr;
    }
}
```

**步骤 2：实现语法高亮**

```javascript
function syntaxHighlightJson(jsonStr) {
    try {
        const obj = JSON.parse(jsonStr);
        return formatJsonWithHighlight(obj);
    } catch (e) {
        return escapeHtml(jsonStr);
    }
}

function formatJsonWithHighlight(obj, indent = 0) {
    const spaces = '  '.repeat(indent);

    if (Array.isArray(obj)) {
        if (obj.length === 0) return '[]';
        return '[\n' + obj.map(item =>
            spaces + '  ' + formatJsonWithHighlight(item, indent + 1)
        ).join(',\n') + '\n' + spaces + ']';
    }

    if (typeof obj === 'object' && obj !== null) {
        const keys = Object.keys(obj);
        if (keys.length === 0) return '{}';
        return '{\n' + keys.map(key => {
            const value = obj[key];
            const highlightedValue = formatJsonWithHighlight(value, indent + 1);
            if (typeof value === 'string') {
                return `${spaces}  <span class="json-key">"${escapeHtml(key)}"</span>: <span class="json-string">"${escapeHtml(value)}"</span>`;
            } else if (typeof value === 'number') {
                return `${spaces}  <span class="json-key">"${escapeHtml(key)}"</span>: <span class="json-number">${value}</span>`;
            } else if (typeof value === 'boolean') {
                return `${spaces}  <span class="json-key">"${escapeHtml(key)}"</span>: <span class="json-boolean">${value}</span>`;
            } else if (value === null) {
                return `${spaces}  <span class="json-key">"${escapeHtml(key)}"</span>: <span class="json-null">null</span>`;
            } else {
                return `${spaces}  <span class="json-key">"${escapeHtml(key)}"</span>: ${highlightedValue}`;
            }
        }).join(',\n') + '\n' + spaces + '}';
    }

    return escapeHtml(String(obj));
}
```

**步骤 3：添加语法高亮 CSS**

```css
.json-key { color: #fab387; }
.json-string { color: #a6e3a1; }
.json-number { color: #fab387; }
.json-boolean { color: #cba6f7; }
.json-null { color: #f38ba8; }
```

**步骤 4：修改 addMessage 函数支持格式化**

```javascript
function addMessage(type, content) {
    // ... 原有代码 ...

    let displayContent = content;
    if (tryParseJson(content)) {
        displayContent = syntaxHighlightJson(content);
    } else {
        displayContent = escapeHtml(content);
    }

    messageEl.innerHTML = `
        <div class="message-meta">...</div>
        <div class="message-content">
            <pre>${displayContent}</pre>
        </div>
    `;

    // ... 后续代码 ...
}
```

**验证：** 发送 JSON 格式消息，检查是否正确高亮显示。

---

### 任务 5：心跳配置

**文件：**
- 修改: `index.html`

**步骤 1：添加心跳配置 UI**

```html
<div class="section-divider"></div>

<div class="section">
    <h2 class="section-title">心跳配置</h2>
    <label class="checkbox-label">
        <input type="checkbox" id="heartbeatEnabled" checked>
        启用心跳
    </label>
    <div class="form-group">
        <label class="form-label">发送间隔（秒）</label>
        <input type="number" id="heartbeatInterval" class="form-input" value="30" min="5">
    </div>
    <div class="heartbeat-mode-options">
        <div class="heartbeat-mode-option active" data-mode="template" onclick="selectHeartbeatMode(this, 'template')">
            <div class="heartbeat-mode-header">
                <input type="radio" name="heartbeatMode" checked>
                <span>选择模板</span>
            </div>
            <select id="heartbeatTemplate" class="template-select">
                <option value="">-- 选择模板 --</option>
            </select>
        </div>
        <div class="heartbeat-mode-option" data-mode="custom" onclick="selectHeartbeatMode(this, 'custom')">
            <div class="heartbeat-mode-header">
                <input type="radio" name="heartbeatMode">
                <span>手动输入</span>
            </div>
            <textarea id="heartbeatMessage" class="form-input" placeholder='{"type":"ping"}'></textarea>
        </div>
    </div>
</div>
```

**步骤 2：实现心跳逻辑**

```javascript
let heartbeatTimer = null;

function startHeartbeat() {
    if (!document.getElementById('heartbeatEnabled').checked) return;

    const interval = parseInt(document.getElementById('heartbeatInterval').value) * 1000;
    const message = getHeartbeatMessage();

    if (!message) return;

    heartbeatTimer = setInterval(() => {
        if (isConnected && ws && ws.readyState === WebSocket.OPEN) {
            try {
                ws.send(message);
                addSystemMessage('心跳发送');
            } catch (error) {
                console.error('Heartbeat error:', error);
            }
        }
    }, interval);
}

function stopHeartbeat() {
    if (heartbeatTimer) {
        clearInterval(heartbeatTimer);
        heartbeatTimer = null;
    }
}

function getHeartbeatMessage() {
    const mode = document.querySelector('.heartbeat-mode-option.active').dataset.mode;

    if (mode === 'template') {
        const select = document.getElementById('heartbeatTemplate');
        const selectedTemplate = templates.find(t => t.id === select.value);
        return selectedTemplate ? selectedTemplate.content : null;
    } else {
        const custom = document.getElementById('heartbeatMessage').value.trim();
        return custom || null;
    }
}

function selectHeartbeatMode(element, mode) {
    document.querySelectorAll('.heartbeat-mode-option').forEach(el => {
        el.classList.remove('active');
        el.querySelector('input[type="radio"]').checked = false;
    });
    element.classList.add('active');
    element.querySelector('input[type="radio"]').checked = true;
}
```

**步骤 3：修改 connect 函数启动心跳**

```javascript
ws.onopen = () => {
    isConnected = true;
    updateConnectionUI(true);
    showToast('连接成功', 'success');
    startHeartbeat();  // 添加这行
};
```

**步骤 4：修改 disconnect 函数停止心跳**

```javascript
function disconnect() {
    stopHeartbeat();  // 添加这行
    if (ws) {
        ws.close();
        ws = null;
    }
    isConnected = false;
    updateConnectionUI(false);
}
```

**验证：** 启用心跳，连接后检查是否按设定间隔发送心跳消息。

---

### 任务 6：自动重连

**文件：**
- 修改: `index.html`

**步骤 1：添加重连配置 UI**

```html
<div class="section-divider"></div>

<div class="section">
    <h2 class="section-title">自动重连</h2>
    <label class="checkbox-label">
        <input type="checkbox" id="reconnectEnabled" checked>
        启用自动重连
    </label>
    <div class="form-group">
        <label class="form-label">最大重试次数</label>
        <input type="number" id="reconnectMaxAttempts" class="form-input" value="5" min="1">
    </div>
    <div class="form-group">
        <label class="form-label">重连间隔（秒）</label>
        <input type="number" id="reconnectInterval" class="form-input" value="3" min="1">
    </div>
</div>
```

**步骤 2：实现重连逻辑**

```javascript
let reconnectAttempts = 0;

ws.onclose = (event) => {
    stopHeartbeat();
    isConnected = false;
    updateConnectionUI(false);

    const reason = event.reason ? ` (${event.reason})` : '';
    addSystemMessage(`连接已关闭${reason} (code: ${event.code})`);

    // 自动重连
    if (document.getElementById('reconnectEnabled').checked) {
        const maxAttempts = parseInt(document.getElementById('reconnectMaxAttempts').value);
        if (reconnectAttempts < maxAttempts) {
            const interval = parseInt(document.getElementById('reconnectInterval').value) * 1000;
            reconnectAttempts++;
            showToast(`${interval / 1000}秒后重连 (${reconnectAttempts}/${maxAttempts})`, 'warning');
            setTimeout(() => {
                if (!isConnected) {
                    connect();
                }
            }, interval);
        } else {
            addSystemMessage('已达到最大重试次数', 'error');
        }
    }
};
```

**步骤 3：重置重连计数**

```javascript
ws.onopen = () => {
    reconnectAttempts = 0;  // 添加这行
    isConnected = true;
    updateConnectionUI(true);
    startHeartbeat();
};
```

**验证：** 断开连接，检查是否自动重连。

---

### 任务 7：消息模板管理

**文件：**
- 修改: `index.html`

**步骤 1：添加模板弹窗**

```html
<div class="modal-overlay" id="templateModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">消息模板管理</h3>
            <button class="modal-close" onclick="closeTemplateModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">模板名称</label>
                <input type="text" id="templateName" class="form-input" placeholder="例如: ping">
            </div>
            <div class="form-group">
                <label class="form-label">模板内容（JSON）</label>
                <textarea id="templateContent" class="form-input" placeholder='{"type":"ping"}'></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">快捷键（1-9）</label>
                <select id="templateShortcut" class="template-select">
                    <option value="">-- 无 --</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                </select>
            </div>
            <button class="btn btn-primary btn-full" onclick="addTemplate()">添加模板</button>
            <div class="section-divider"></div>
            <div class="template-list" id="templateList"></div>
        </div>
    </div>
</div>
```

**步骤 2：实现模板管理逻辑**

```javascript
let templates = [
    { id: '1', name: 'Ping', content: '{"type":"ping"}', shortcut: '' },
    { id: '2', name: 'Pong', content: '{"type":"pong"}', shortcut: '' },
    { id: '3', name: 'Login', content: '{"event":"login","token":"your-token"}', shortcut: '' }
];

function openTemplateModal() {
    document.getElementById('templateModal').classList.add('active');
    renderTemplates();
}

function closeTemplateModal() {
    document.getElementById('templateModal').classList.remove('active');
}

function addTemplate() {
    const name = document.getElementById('templateName').value.trim();
    const content = document.getElementById('templateContent').value.trim();
    const shortcut = document.getElementById('templateShortcut').value;

    if (!name || !content) {
        showToast('请填写模板名称和内容', 'error');
        return;
    }

    if (!tryParseJson(content)) {
        showToast('模板内容必须是有效的 JSON', 'error');
        return;
    }

    // 检查快捷键冲突
    if (shortcut && templates.some(t => t.shortcut === shortcut)) {
        showToast('该快捷键已被使用', 'error');
        return;
    }

    templates.push({
        id: Date.now().toString(),
        name,
        content,
        shortcut
    });

    // 清空输入
    document.getElementById('templateName').value = '';
    document.getElementById('templateContent').value = '';
    document.getElementById('templateShortcut').value = '';

    renderTemplates();
    updateTemplateSelect();
    saveToStorage();
    showToast('模板已添加', 'success');
}

function deleteTemplate(id) {
    templates = templates.filter(t => t.id !== id);
    renderTemplates();
    updateTemplateSelect();
    saveToStorage();
    showToast('模板已删除', 'success');
}

function useTemplate(id) {
    const template = templates.find(t => t.id === id);
    if (template) {
        document.getElementById('messageInput').value = template.content;
        sendMessage();
    }
}

function renderTemplates() {
    const container = document.getElementById('templateList');

    if (templates.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-text">暂无模板</div></div>';
        return;
    }

    container.innerHTML = templates.map(t => `
        <div class="template-item" onclick="useTemplate('${t.id}')">
            <div class="template-info">
                <div class="template-name">${escapeHtml(t.name)}</div>
                <div class="template-preview">${escapeHtml(t.content)}</div>
            </div>
            ${t.shortcut ? `<span class="template-shortcut">${t.shortcut}</span>` : ''}
            <div class="template-actions" onclick="event.stopPropagation()">
                <button class="message-action-btn" onclick="deleteTemplate('${t.id}')">删除</button>
            </div>
        </div>
    `).join('');
}

function updateTemplateSelect() {
    const select = document.getElementById('heartbeatTemplate');
    select.innerHTML = `
        <option value="">-- 选择模板 --</option>
        ${templates.map(t => `<option value="${t.id}">${escapeHtml(t.name)}</option>`).join('')}
    `;
}
```

**步骤 3：实现快捷键发送**

```javascript
document.addEventListener('keydown', (e) => {
    // 模板快捷键 (1-9)
    if (e.key >= '1' && e.key <= '9' && !e.ctrlKey && !e.metaKey && !e.altKey) {
        if (!['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
            const template = templates.find(t => t.shortcut === e.key);
            if (template && isConnected) {
                useTemplate(template.id);
            }
        }
    }
    // ... 其他快捷键 ...
});
```

**验证：** 添加模板，使用快捷键发送，检查是否正常工作。

---

### 任务 8：配置导入导出

**文件：**
- 修改: `index.html`

**步骤 1：添加隐藏文件输入**

```html
<input type="file" id="importInput" class="hidden-input" accept=".json" onchange="importConfig(event)">
```

**步骤 2：实现导出功能**

```javascript
function exportConfig() {
    const config = {
        url: document.getElementById('wsUrl').value,
        protocol: document.querySelector('input[name="protocol"]:checked').value,
        heartbeat: {
            enabled: document.getElementById('heartbeatEnabled').checked,
            interval: document.getElementById('heartbeatInterval').value,
            mode: document.querySelector('.heartbeat-mode-option.active').dataset.mode,
            templateId: document.getElementById('heartbeatTemplate').value,
            customMessage: document.getElementById('heartbeatMessage').value
        },
        reconnect: {
            enabled: document.getElementById('reconnectEnabled').checked,
            maxAttempts: document.getElementById('reconnectMaxAttempts').value,
            interval: document.getElementById('reconnectInterval').value
        },
        templates: templates
    };

    const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `websocket-config-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);

    showToast('配置已导出', 'success');
}
```

**步骤 3：实现导入功能**

```javascript
function importConfig(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const config = JSON.parse(e.target.result);

            if (config.url) document.getElementById('wsUrl').value = config.url;
            if (config.protocol) {
                document.querySelector(`input[name="protocol"][value="${config.protocol}"]`).checked = true;
            }
            if (config.heartbeat) {
                document.getElementById('heartbeatEnabled').checked = config.heartbeat.enabled;
                document.getElementById('heartbeatInterval').value = config.heartbeat.interval || 30;
                document.getElementById('heartbeatMessage').value = config.heartbeat.customMessage || '';
                if (config.heartbeat.templateId) {
                    document.getElementById('heartbeatTemplate').value = config.heartbeat.templateId;
                }
            }
            if (config.reconnect) {
                document.getElementById('reconnectEnabled').checked = config.reconnect.enabled;
                document.getElementById('reconnectMaxAttempts').value = config.reconnect.maxAttempts || 5;
                document.getElementById('reconnectInterval').value = config.reconnect.interval || 3;
            }
            if (config.templates) {
                templates = config.templates;
                renderTemplates();
                updateTemplateSelect();
            }

            saveToStorage();
            showToast('配置已导入', 'success');

        } catch (error) {
            showToast('导入失败: ' + error.message, 'error');
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}
```

**验证：** 导出配置，修改后导入，检查配置是否正确恢复。

---

### 任务 9：本地存储持久化

**文件：**
- 修改: `index.html`

**步骤 1：实现保存和加载**

```javascript
function saveToStorage() {
    const config = {
        url: document.getElementById('wsUrl').value,
        protocol: document.querySelector('input[name="protocol"]:checked').value,
        heartbeat: {
            enabled: document.getElementById('heartbeatEnabled').checked,
            interval: document.getElementById('heartbeatInterval').value,
            mode: document.querySelector('.heartbeat-mode-option.active').dataset.mode,
            templateId: document.getElementById('heartbeatTemplate').value,
            customMessage: document.getElementById('heartbeatMessage').value
        },
        reconnect: {
            enabled: document.getElementById('reconnectEnabled').checked,
            maxAttempts: document.getElementById('reconnectMaxAttempts').value,
            interval: document.getElementById('reconnectInterval').value
        },
        templates: templates
    };

    localStorage.setItem('ws-debug-config', JSON.stringify(config));
}

function loadFromStorage() {
    try {
        const saved = localStorage.getItem('ws-debug-config');
        if (!saved) return;

        const config = JSON.parse(saved);

        if (config.url) document.getElementById('wsUrl').value = config.url;
        if (config.protocol) {
            const radio = document.querySelector(`input[name="protocol"][value="${config.protocol}"]`);
            if (radio) radio.checked = true;
        }
        if (config.heartbeat) {
            document.getElementById('heartbeatEnabled').checked = config.heartbeat.enabled;
            document.getElementById('heartbeatInterval').value = config.heartbeat.interval || 30;
            document.getElementById('heartbeatMessage').value = config.heartbeat.customMessage || '';
            if (config.heartbeat.templateId) {
                document.getElementById('heartbeatTemplate').value = config.heartbeat.templateId;
            }
        }
        if (config.reconnect) {
            document.getElementById('reconnectEnabled').checked = config.reconnect.enabled;
            document.getElementById('reconnectMaxAttempts').value = config.reconnect.maxAttempts || 5;
            document.getElementById('reconnectInterval').value = config.reconnect.interval || 3;
        }
        if (config.templates) {
            templates = config.templates;
        }

    } catch (error) {
        console.error('Failed to load config:', error);
    }
}
```

**步骤 2：在页面加载时调用**

```javascript
document.addEventListener('DOMContentLoaded', () => {
    loadFromStorage();
    renderTemplates();
    updateTemplateSelect();
});
```

**步骤 3：在关键操作时保存**

- 连接成功时
- 添加/删除模板时
- 修改配置时

**验证：** 刷新页面，检查配置是否自动恢复。

---

### 任务 10：设置弹窗

**文件：**
- 修改: `index.html`

**步骤 1：添加设置弹窗**

```html
<div class="modal-overlay" id="settingsModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">设置</h3>
            <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="autoFormatJson" checked>
                    自动格式化 JSON 消息
                </label>
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="syntaxHighlight" checked>
                    启用语法高亮
                </label>
            </div>
            <div class="section-divider"></div>
            <button class="btn btn-danger btn-full" onclick="clearAllData()">清除所有数据</button>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="saveSettings()">保存</button>
            <button class="btn btn-secondary" onclick="closeSettingsModal()">取消</button>
        </div>
    </div>
</div>
```

**步骤 2：实现设置功能**

```javascript
function openSettingsModal() {
    document.getElementById('settingsModal').classList.add('active');
}

function closeSettingsModal() {
    document.getElementById('settingsModal').classList.remove('active');
}

function saveSettings() {
    saveToStorage();
    closeSettingsModal();
    showToast('设置已保存', 'success');
}

function clearAllData() {
    if (confirm('确定要清除所有数据吗？此操作不可恢复。')) {
        localStorage.removeItem('ws-debug-config');
        templates = [
            { id: '1', name: 'Ping', content: '{"type":"ping"}', shortcut: '' },
            { id: '2', name: 'Pong', content: '{"type":"pong"}', shortcut: '' },
            { id: '3', name: 'Login', content: '{"event":"login","token":"your-token"}', shortcut: '' }
        ];
        renderTemplates();
        updateTemplateSelect();
        showToast('所有数据已清除', 'success');
    }
}
```

**验证：** 打开设置弹窗，修改设置后保存，刷新页面检查设置是否保留。

---

### 任务 11：Toast 通知组件

**文件：**
- 修改: `index.html`

**步骤 1：添加 Toast 容器**

```html
<div class="toast-container" id="toastContainer"></div>
```

**步骤 2：实现 Toast 函数**

```javascript
function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);

    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
```

**步骤 3：添加 Toast CSS**

```css
.toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 2000;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.toast {
    padding: 12px 20px;
    border-radius: 8px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: 13px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    animation: slideIn 0.3s ease;
}

.toast.success { border-left: 3px solid var(--success); }
.toast.error { border-left: 3px solid var(--error); }
.toast.warning { border-left: 3px solid var(--warning); }

@keyframes slideIn {
    from { opacity: 0; transform: translateX(100px); }
    to { opacity: 1; transform: translateX(0); }
}
```

**验证：** 触发各种操作，检查 Toast 通知是否正常显示。

---

### 任务 12：消息复制功能

**文件：**
- 修改: `index.html`

**步骤 1：修改消息模板添加复制按钮**

```javascript
messageEl.innerHTML = `
    <div class="message-meta">...</div>
    <div class="message-content">
        <pre>${displayContent}</pre>
        <div class="message-actions">
            <button class="message-action-btn" onclick="copyMessage(${messageObj.id})" title="复制">复制</button>
        </div>
    </div>
`;
```

**步骤 2：实现复制函数**

```javascript
function copyMessage(id) {
    const msg = messages.find(m => m.id === id);
    if (msg) {
        navigator.clipboard.writeText(msg.content).then(() => {
            showToast('已复制到剪贴板', 'success');
        });
    }
}
```

**验证：** 点击消息旁边的复制按钮，检查是否正确复制到剪贴板。

---

### 任务 13：UI 样式完善

**文件：**
- 修改: `index.html`

**步骤 1：完善所有 CSS 样式**

添加完整的组件样式：
- 按钮样式（primary、secondary、danger）
- 表单样式
- 弹窗样式
- 滚动条样式
- 动画效果

**验证：** 所有 UI 组件样式一致，动画流畅。

---

### 任务 14：全面测试

**验证清单：**

1. **连接功能**
   - [ ] 输入有效 URL，点击连接
   - [ ] 连接成功，状态变为"已连接"
   - [ ] 断开连接，状态变为"未连接"

2. **消息功能**
   - [ ] 发送文本消息
   - [ ] 发送 JSON 消息，格式化正确
   - [ ] 接收服务器消息
   - [ ] 复制消息内容
   - [ ] 清空消息历史

3. **心跳功能**
   - [ ] 启用心跳，设置间隔
   - [ ] 按时收到心跳消息
   - [ ] 选择模板作为心跳内容
   - [ ] 手动输入心跳内容

4. **自动重连**
   - [ ] 断开后自动重连
   - [ ] 达到最大次数后停止重连

5. **模板管理**
   - [ ] 添加新模板
   - [ ] 删除模板
   - [ ] 使用模板发送消息
   - [ ] 快捷键发送模板

6. **配置管理**
   - [ ] 导出配置为 JSON 文件
   - [ ] 从 JSON 文件导入配置
   - [ ] 刷新页面后配置恢复
   - [ ] 清除所有数据

7. **快捷键**
   - [ ] Ctrl+Enter 发送消息
   - [ ] Esc 断开连接
   - [ ] 1-9 快速发送模板

---

**计划完成。保存至 `docs/plans/实现计划.md`。**

**两种执行方式：**

1. **Subagent-Driven（本会话）** - 每个任务由新的子代理执行，代码审查
2. **Parallel Session（单独会话）** - 新会话中使用 executing-plans，批量执行

选择哪种方式？